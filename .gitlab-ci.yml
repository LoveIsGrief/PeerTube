image: chocobozzz/peertube-ci:8

stages:
  - dependencies
  - build-and-lint
  - test

before_script:
  - if [[ $CI_JOB_STAGE == "test" ]]; then psql -c "create user peertube with password 'peertube';"; fi
  - yarn install --pure-lockfile --cache-folder .yarn-cache

cache:
  key: yarn
  paths:
    - .yarn-cache

###
## Jobs templates
#
.build-and-lint: &build-and-lint
  stage: build-and-lint

.tests: &tests
  stage: test
  dependencies:
    - build-server
  services:
    - name: postgres:9.6
      alias: postgres
    - name: redis:latest
      alias: redis
  variables:
    PGHOST: postgres
    PGUSER: postgres
    REDIS_HOST: redis
  artifacts:
    expire_in: 1 day
    paths:
      - test1/
      - test2/
      - test3/
    when: always

###
## Build and lint
#
build-server:
  <<: *build-and-lint
  artifacts:
    expire_in: 1h
    paths:
      - dist/
  script:
    - npm run build:server

lint:
  <<: *build-and-lint
  script:
    - npm run tslint -- --project ./tsconfig.json -c ./tslint.json server.ts "server/**/*.ts" "shared/**/*.ts"
    - cd client && npm run lint

jest:
  <<: *build-and-lint
  script:
    - cd client && npm run test

###
## Tests
#
test-misc:
  <<: *tests
  script:
    - npm run build:client -- --light-fr
    - npm run mocha -- --timeout 30000 --exit --require ts-node/register --bail server/tests/client.ts

test-cli:
  <<: *tests
  retry:
    max: 1
  script:
    - npm run mocha -- --timeout 30000 --exit --require ts-node/register --bail server/tests/cli/peertube.ts
    - npm run mocha -- --timeout 30000 --exit --require ts-node/register --bail server/tests/cli/reset-password.ts
    - npm run mocha -- --timeout 30000 --exit --require ts-node/register --bail server/tests/cli/update-host.ts
    - npm run mocha -- --timeout 30000 --exit --require ts-node/register --bail server/tests/cli/create-import-video-file-job.ts
    - npm run mocha -- --timeout 30000 --exit --require ts-node/register --bail server/tests/cli/create-transcoding-job.ts
    - npm run mocha -- --timeout 30000 --exit --require ts-node/register --bail server/tests/cli/optimize-old-videos.ts

api:
  <<: *tests
  parallel: 4
  script:
    - npm run mocha -- --timeout 30000 --exit --require ts-node/register --bail server/tests/api/index-$CI_NODE_INDEX.ts
